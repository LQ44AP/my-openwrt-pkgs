name: Build libldac IPK

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # 在这里定义你的路由器架构（例如 x86_64, aarch64_generic, mipsel_24kc）
        target: [x86_64, aarch64_generic]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Initialization environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev swig libpython3-dev cmake

      - name: Download SDK
        run: |
          # 这里以 OpenWrt 23.05 x86_64 为例，你需要根据你的固件版本更换 URL
          if [ "${{ matrix.target }}" == "x86_64" ]; then
            SDK_URL="https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          else
            SDK_URL="https://downloads.openwrt.org/releases/23.05.5/rockchip/armv8/openwrt-sdk-23.05.6-rockchip-armv8_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          fi
          wget $SDK_URL
          tar xf *.tar.xz
          mv openwrt-sdk-* sdk

      - name: Add libldac package
        run: |
          mkdir -p sdk/package/libldac
          cp package/libs/libldac/Makefile sdk/package/libldac/

      - name: Compile IPK
        run: |
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          # 只编译 libldac
          make package/libldac/compile V=s

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: libldac-ipk-${{ matrix.target }}
          path: sdk/bin/packages/*/base/libldac*.ipk
